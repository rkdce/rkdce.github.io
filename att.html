<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Attendance System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .form-container {
            width: 90%;
            max-width: 800px;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .tabs {
            text-align: center;
            margin-bottom: 20px;
        }

        .tab {
            cursor: pointer;
            padding: 10px 20px;
            display: inline-block;
            background-color: #ddd;
            border-radius: 5px;
            margin: 0 10px;
            transition: background-color 0.3s;
        }

        .tab:hover, .active {
            background-color: #4CAF50;
            color: white;
        }

        .form {
            display: none;
        }

        .show {
            display: block;
        }

        input[type="text"],
        input[type="password"],
        input[type="email"],
        input[type="date"] {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background-color: #45a049;
        }

        p {
            text-align: center;
        }

        select {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            font-size: 16px;
            background-color: white;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        .select-wrapper {
            position: relative;
            width: 100%;
        }

        .select-wrapper::after {
            content: "â–¼";
            position: absolute;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            pointer-events: none;
            color: #555;
            font-size: 12px;
        }

        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4CAF50;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Attendance Table Styles */
        .attendance-container {
            display: none;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #4CAF50;
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .present-btn {
            background-color: #4CAF50;
        }

        .absent-btn {
            background-color: #f44336;
        }

        .halfday-btn {
            background-color: #FFA500;
        }

        .leave-btn {
            background-color: #800080;
        }

        .status-present {
            color: #4CAF50;
            font-weight: bold;
        }

        .status-absent {
            color: #f44336;
            font-weight: bold;
        }

        .status-halfday {
            color: #FFA500;
            font-weight: bold;
        }

        .status-leave {
            color: #800080;
            font-weight: bold;
        }

        .attendance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .logout-btn {
            background-color: #f44336;
        }

        .attendance-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .success-message {
            color: green;
        }

        .error-message {
            color: red;
        }

        .info-message {
            color: #2196F3;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 900px;
            border-radius: 8px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        .chart-container {
            position: relative;
            width: 100%;
            min-height: 400px;
            margin-top: 20px;
        }

        .chart-container canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            margin: 0;
            font-size: 24px;
        }

        .date-range-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .date-range-selector label {
            font-weight: bold;
        }

        .stats-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-width: 150px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin: 5px 0;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .present-stat {
            color: #4CAF50;
        }

        .absent-stat {
            color: #f44336;
        }

        .halfday-stat {
            color: #FFA500;
        }

        .leave-stat {
            color: #800080;
        }

        .student-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .student-selector {
            margin: 15px 0;
        }

        .student-selector select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            width: 100%;
            max-width: 300px;
        }

        .student-chart-container {
            margin-top: 20px;
        }

        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            background: #f1f1f1;
            border: none;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }

        .tab-button.active {
            background: #4CAF50;
            color: white;
        }
    </style>
    <!-- Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="form-container" id="loginContainer">
    <div class="tabs">
        <div class="tab active" onclick="showForm('login')">Login</div>
        <div class="tab" onclick="showForm('register')">Register</div>
    </div>

    <div id="loginForm" class="form show">
        <input type="text" id="loginUsername" placeholder="Username" required>
        <input type="password" id="loginPassword" placeholder="Password" required>
        <button onclick="handleLogin()">Login</button>
        <p id="loginMessage"></p>
    </div>

    <div id="registerForm" class="form">
        <form id="registrationForm">
            <div class="select-wrapper">
                <select id="regUserType" required>
                    <option value="">-- Select User Type --</option>
                    <option value="Teacher">Teacher</option>
                    <option value="Admin">Admin</option>
                </select>
            </div>
            <input type="text" id="regUsername" placeholder="Username" required>
            <div class="select-wrapper">
                <select id="regTeacherClass" required>
                    <option value="">-- Select Class --</option>
                    <option value="NURSERY">NURSERY</option>
                    <option value="KG1">KG1</option>
                    <option value="KG2">KG2</option>
                    <option value="I">I</option>
                    <option value="II">II</option>
                    <option value="III">III</option>
                    <option value="IV">IV</option>
                    <option value="V">V</option>
                    <option value="VI">VI</option>
                    <option value="VII">VII</option>
                    <option value="VIII">VIII</option>
                    <option value="IX">IX</option>
                    <option value="X">X</option>
                    <option value="XI SCIENCE">XI SCIENCE</option>
                    <option value="XI ARTS">XI ARTS</option>
                    <option value="XII SCIENCE">XII SCIENCE</option>
                    <option value="XII ARTS">XII ARTS</option>
                </select>
            </div>
            <input type="text" id="regPhone" placeholder="Mobile No." required>
            <input type="email" id="regEmail" placeholder="Email" required>
            <input type="password" id="regPassword" placeholder="Password" required>
            <button type="submit">Register</button>
            <p id="regMessage"></p>
        </form>
    </div>
</div>

<div class="form-container" id="attendanceContainer" style="display: none;">
    <div class="attendance-header">
        <h2 id="classTitle">Class Attendance</h2>
        <div>
            <button class="view-stats-btn" onclick="openAttendanceStatsModal()">View Attendance Stats</button>
            <button class="logout-btn" onclick="handleLogout()">Logout</button>
        </div>
    </div>
    
    <div class="select-wrapper">
        <input type="date" id="attendanceDate" required>
    </div>
    
    <div id="studentListContainer">
        <table id="studentTable">
            <thead>
                <tr>
                    <th>Student ID</th>
                    <th>Student Name</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="studentTableBody">
                <!-- Student data will be populated here -->
            </tbody>
        </table>
    </div>
    
    <div class="attendance-actions">
        <button onclick="saveAttendance()">Save Attendance</button>
        <button onclick="loadAttendance()">Load Attendance</button>
    </div>
    
    <p id="attendanceMessage"></p>
</div>

<!-- Attendance Stats Modal -->
<div id="attendanceStatsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Attendance Statistics</h2>
            <span class="close" onclick="closeAttendanceStatsModal()">&times;</span>
        </div>
        
        <div class="date-range-selector">
            <label for="statsStartDate">From:</label>
            <input type="date" id="statsStartDate">
            
            <label for="statsEndDate">To:</label>
            <input type="date" id="statsEndDate">
            
            <button onclick="loadAttendanceStats()">Load Stats</button>
        </div>
        
        <div class="tab-buttons">
            <button class="tab-button active" onclick="showTab('classStats')">Class Statistics</button>
            <button class="tab-button" onclick="showTab('studentStats')">Student Statistics</button>
        </div>
        
        <div id="classStatsTab" class="tab-content">
            <div class="stats-container" id="summaryStats"></div>
            <div class="chart-container">
                <canvas id="attendanceChart"></canvas>
            </div>
        </div>
        
        <div id="studentStatsTab" class="tab-content" style="display: none;">
            <div class="student-section">
                <div class="student-selector">
                    <label for="studentSelect">Select Student:</label>
                    <select id="studentSelect">
                        <option value="">-- Select Student --</option>
                        <!-- Students will be populated here -->
                    </select>
                    <button onclick="loadStudentChart()" style="margin-left: 10px;">Load Student Data</button>
                </div>
                
                <div class="student-info" id="studentInfo" style="margin: 15px 0; font-weight: bold; display: none;">
                    <!-- Student info will appear here -->
                </div>
                
                <div class="chart-container">
                    <canvas id="studentAttendanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="loader" class="loader" style="display: none;">
    <div class="spinner"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxwQBtUKAw0WdA8Fqkahm5_NKYyaB2mgpbjIHZZrRE9C37TBanVyLovswAUMgqcJUFBFw/exec';
    let currentUser = null;
    let studentData = [];
    let attendanceData = {};
    let attendanceChart = null;
    let studentChart = null;

    // Initialize the date picker with today's date
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('attendanceDate').value = today;
        
        // Set default dates for stats (current month)
        const startOfMonth = new Date();
        startOfMonth.setDate(1);
        document.getElementById('statsStartDate').value = startOfMonth.toISOString().split('T')[0];
        document.getElementById('statsEndDate').value = today;
        
        // Check if user is already logged in
        const savedUser = localStorage.getItem('user');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            if (currentUser.userType === 'Teacher') {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('attendanceContainer').style.display = 'block';
                document.getElementById('classTitle').textContent = `${currentUser.tClass} Attendance`;
                loadStudents();
            }
        }
        
        // Set up form event listeners
        document.getElementById('registrationForm').addEventListener('submit', handleRegister);
        
        // Load attendance when date changes
        document.getElementById('attendanceDate').addEventListener('change', function() {
            loadAttendance();
        });
    });

    function showForm(formType) {
        document.querySelectorAll('.form').forEach(f => f.classList.remove('show'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`${formType}Form`).classList.add('show');
        document.querySelector(`[onclick="showForm('${formType}')"]`).classList.add('active');
    }

    function showTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.style.display = 'none';
        });
        
        // Remove active class from all buttons
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected tab and mark button as active
        document.getElementById(`${tabName}Tab`).style.display = 'block';
        event.target.classList.add('active');
    }

    function hashPassword(password) {
        return CryptoJS.SHA256(password).toString();
    }

    async function handleLogin() {
        const username = document.getElementById('loginUsername').value;
        const password = hashPassword(document.getElementById('loginPassword').value);

        try {
            document.getElementById('loader').style.display = 'flex';
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'login',
                    username: username,
                    password: password
                })
            });
            const data = await response.json();

            const loginMessage = document.getElementById('loginMessage');
            loginMessage.textContent = data.message;
            
            if (data.status === 'success') {
                currentUser = data.user;
                localStorage.setItem('user', JSON.stringify(currentUser));
                
                if (currentUser.userType === 'Teacher') {
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('attendanceContainer').style.display = 'block';
                    document.getElementById('classTitle').textContent = `${currentUser.tClass} Attendance`;
                    loadStudents();
                } else {
                    window.location.href = 'admin_dashboard.html';
                }
            } else {
                loginMessage.className = 'error-message';
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('loginMessage').textContent = 'An error occurred during login.';
            document.getElementById('loginMessage').className = 'error-message';
        } finally {
            document.getElementById('loader').style.display = 'none';
        }
    }

    async function handleRegister(event) {
        event.preventDefault();
        
        const username = document.getElementById('regUsername').value;
        const email = document.getElementById('regEmail').value;
        const password = hashPassword(document.getElementById('regPassword').value);
        const userType = document.getElementById('regUserType').value;
        const tClass = document.getElementById('regTeacherClass').value;
        const tPhone = document.getElementById('regPhone').value;

        try {
            document.getElementById('loader').style.display = 'flex';
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'register',
                    userType: userType,
                    username: username,
                    tClass: tClass,
                    tPhone: tPhone,
                    email: email,
                    password: password,
                })
            });
            const data = await response.json();

            const regMessage = document.getElementById('regMessage');
            regMessage.textContent = data.message;
            
            if (data.status === 'success') {
                regMessage.className = 'success-message';
                document.getElementById('registrationForm').reset();
            } else {
                regMessage.className = 'error-message';
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('regMessage').textContent = 'An error occurred during registration.';
            document.getElementById('regMessage').className = 'error-message';
        } finally {
            document.getElementById('loader').style.display = 'none';
        }
    }

    async function loadStudents() {
        try {
            document.getElementById('loader').style.display = 'flex';
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'getStudents',
                    class: currentUser.tClass
                })
            });
            const data = await response.json();

            if (data.status === 'success') {
                studentData = data.students;
                renderStudentTable();
                populateStudentDropdown();
                loadAttendance();
            } else {
                showMessage('attendanceMessage', data.message, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showMessage('attendanceMessage', 'Error loading students', 'error');
        } finally {
            document.getElementById('loader').style.display = 'none';
        }
    }

    function renderStudentTable() {
        const tableBody = document.getElementById('studentTableBody');
        tableBody.innerHTML = '';
        const date = document.getElementById('attendanceDate').value;
        
        if (!date) return; // Don't render if no date selected
        
        studentData.forEach(student => {
            const row = document.createElement('tr');
            
            // Student ID
            const idCell = document.createElement('td');
            idCell.textContent = student.studentId;
            row.appendChild(idCell);
            
            // Student Name
            const nameCell = document.createElement('td');
            nameCell.textContent = student.studentName;
            row.appendChild(nameCell);
            
            // Status
            const statusCell = document.createElement('td');
            statusCell.id = `status-${student.studentId}`;
            
            // Get status for this date+student
            const status = attendanceData[date] && attendanceData[date][student.studentId] 
                ? attendanceData[date][student.studentId] 
                : 'Present';
            
            statusCell.textContent = status;
            statusCell.className = `status-${status.toLowerCase().replace(' ', '')}`;
            row.appendChild(statusCell);
            
            // Action cell with all four buttons
            const actionCell = document.createElement('td');
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'action-buttons';
            
            // Present Button
            const presentBtn = document.createElement('button');
            presentBtn.textContent = 'Present';
            presentBtn.className = 'present-btn';
            presentBtn.onclick = () => markAttendance(student.studentId, 'Present');
            buttonContainer.appendChild(presentBtn);
            
            // Absent Button
            const absentBtn = document.createElement('button');
            absentBtn.textContent = 'Absent';
            absentBtn.className = 'absent-btn';
            absentBtn.onclick = () => markAttendance(student.studentId, 'Absent');
            buttonContainer.appendChild(absentBtn);
            
            // Half Day Button
            const halfdayBtn = document.createElement('button');
            halfdayBtn.textContent = 'Half Day';
            halfdayBtn.className = 'halfday-btn';
            halfdayBtn.onclick = () => markAttendance(student.studentId, 'Half Day');
            buttonContainer.appendChild(halfdayBtn);
            
            // Leave Button
            const leaveBtn = document.createElement('button');
            leaveBtn.textContent = 'Leave';
            leaveBtn.className = 'leave-btn';
            leaveBtn.onclick = () => markAttendance(student.studentId, 'Leave');
            buttonContainer.appendChild(leaveBtn);
            
            actionCell.appendChild(buttonContainer);
            row.appendChild(actionCell);
            tableBody.appendChild(row);
        });
    }

    function markAttendance(studentId, status) {
        const date = document.getElementById('attendanceDate').value;
        if (!date) {
            showMessage('attendanceMessage', 'Please select a date', 'error');
            return;
        }
        
        if (!attendanceData[date]) {
            attendanceData[date] = {};
        }
        
        attendanceData[date][studentId] = status;
        const statusCell = document.getElementById(`status-${studentId}`);
        statusCell.textContent = status;
        statusCell.className = `status-${status.toLowerCase().replace(' ', '')}`;
        document.getElementById('attendanceMessage').textContent = '';
    }

    async function saveAttendance() {
        const dateInput = document.getElementById('attendanceDate');
        const date = new Date(dateInput.value).toISOString().split('T')[0]; // Format as YYYY-MM-DD
        const messageElement = document.getElementById('attendanceMessage');
        
        try {
            // Show loading state
            messageElement.textContent = 'Saving attendance...';
            messageElement.className = 'info-message';
            
            // Prepare attendance data
            const attendanceToSave = {};
            studentData.forEach(student => {
                const status = attendanceData[dateInput.value]?.[student.studentId];
                if (status) {
                    attendanceToSave[student.studentId] = {
                        status: status,
                        name: student.studentName
                    };
                }
            });

            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'saveOrUpdateAttendance',
                    teacherId: currentUser.username,
                    class: currentUser.tClass,
                    date: date,
                    attendance: attendanceToSave
                })
            });
            
            const result = await response.json();
            
            // Show success/error message in the attendanceMessage element
            showMessage('attendanceMessage', result.message, result.status);
            
        } catch (error) {
            console.error('Error:', error);
            showMessage('attendanceMessage', 'Error saving attendance', 'error');
        }
    }

    async function loadAttendance() {
        const dateInput = document.getElementById('attendanceDate').value;
        if (!dateInput) {
            showMessage('attendanceMessage', 'Please select a date', 'error');
            return;
        }

        try {
            document.getElementById('loader').style.display = 'flex';
            
            // Format date consistently
            const dateObj = new Date(dateInput);
            const formattedDate = dateObj.toISOString().split('T')[0];
            
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'loadAttendance',
                    class: currentUser.tClass,
                    date: formattedDate
                })
            });
            const data = await response.json();

            if (data.status === 'success') {
                // Clear existing data for this date
                if (!attendanceData[dateInput]) {
                    attendanceData[dateInput] = {};
                } else {
                    // Clear only the current date's data
                    attendanceData[dateInput] = {};
                }

                if (data.attendance && data.attendance.length > 0) {
                    // Load existing attendance
                    data.attendance.forEach(record => {
                        attendanceData[dateInput][record.studentId] = record.status;
                    });
                    showMessage('attendanceMessage', 'Attendance loaded', 'success');
                } else {
                    // Initialize with Present if no records exist
                    studentData.forEach(student => {
                        attendanceData[dateInput][student.studentId] = 'Present';
                    });
                    showMessage('attendanceMessage', 'New attendance initialized', 'success');
                }
                
                // Force re-render of the table
                renderStudentTable();
            } else {
                showMessage('attendanceMessage', data.message, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showMessage('attendanceMessage', 'Error loading attendance', 'error');
        } finally {
            document.getElementById('loader').style.display = 'none';
        }
    }

    function handleLogout() {
        currentUser = null;
        localStorage.removeItem('user');
        document.getElementById('loginContainer').style.display = 'block';
        document.getElementById('attendanceContainer').style.display = 'none';
        document.getElementById('loginUsername').value = '';
        document.getElementById('loginPassword').value = '';
        document.getElementById('loginMessage').textContent = '';
    }

    function showMessage(elementId, message, type) {
        const element = document.getElementById(elementId);
        element.textContent = message;
        element.className = type === 'success' ? 'success-message' : 'error-message';
    }

    // Attendance Stats Modal Functions
    function openAttendanceStatsModal() {
        document.getElementById('attendanceStatsModal').style.display = 'block';
        loadAttendanceStats();
    }

    function closeAttendanceStatsModal() {
        document.getElementById('attendanceStatsModal').style.display = 'none';
    }

    async function loadAttendanceStats() {
        try {
            document.getElementById('loader').style.display = 'flex';
            
            const startDate = document.getElementById('statsStartDate').value;
            const endDate = document.getElementById('statsEndDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'getAttendanceStats',
                    class: currentUser.tClass,
                    startDate: startDate,
                    endDate: endDate
                })
            });
            
            const data = await response.json();
            console.log('Received stats data:', data);
            
            if (data.status === 'success') {
                if (data.stats && data.stats.length > 0) {
                    renderAttendanceStats(data.stats);
                    renderAttendanceChart(data.stats);
                } else {
                    alert('No attendance data found for the selected date range');
                    renderAttendanceChart([]);
                }
            } else {
                alert(data.message || 'Error loading attendance statistics');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error loading attendance statistics');
        } finally {
            document.getElementById('loader').style.display = 'none';
        }
    }

    function renderAttendanceStats(stats) {
        const summaryStatsContainer = document.getElementById('summaryStats');
        summaryStatsContainer.innerHTML = '';
        
        // Calculate totals
        const totalPresent = stats.reduce((sum, day) => sum + (day.present || 0), 0);
        const totalAbsent = stats.reduce((sum, day) => sum + (day.absent || 0), 0);
        const totalHalfDay = stats.reduce((sum, day) => sum + (day.halfDay || 0), 0);
        const totalLeave = stats.reduce((sum, day) => sum + (day.leave || 0), 0);
        const totalStudents = studentData.length;
        const totalDays = stats.length;
        
        // Create stat cards
        const createStatCard = (value, label, className = '') => {
            const card = document.createElement('div');
            card.className = `stat-card ${className}`;
            card.innerHTML = `
                <div class="stat-value">${value}</div>
                <div class="stat-label">${label}</div>
            `;
            return card;
        };
        
        // Add stat cards to container
        summaryStatsContainer.appendChild(createStatCard(totalPresent, 'Total Present', 'present-stat'));
        summaryStatsContainer.appendChild(createStatCard(totalAbsent, 'Total Absent', 'absent-stat'));
        summaryStatsContainer.appendChild(createStatCard(totalHalfDay, 'Total Half Day', 'halfday-stat'));
        summaryStatsContainer.appendChild(createStatCard(totalLeave, 'Total Leave', 'leave-stat'));
        
        // Calculate and add percentage cards
        const totalRecords = totalDays * totalStudents;
        if (totalRecords > 0) {
            const presentPercentage = Math.round((totalPresent / totalRecords) * 100);
            const absentPercentage = Math.round((totalAbsent / totalRecords) * 100);
            const halfDayPercentage = Math.round((totalHalfDay / totalRecords) * 100);
            const leavePercentage = Math.round((totalLeave / totalRecords) * 100);
            
            summaryStatsContainer.appendChild(createStatCard(`${presentPercentage}%`, 'Present Rate', 'present-stat'));
            summaryStatsContainer.appendChild(createStatCard(`${absentPercentage}%`, 'Absent Rate', 'absent-stat'));
            summaryStatsContainer.appendChild(createStatCard(`${halfDayPercentage}%`, 'Half Day Rate', 'halfday-stat'));
            summaryStatsContainer.appendChild(createStatCard(`${leavePercentage}%`, 'Leave Rate', 'leave-stat'));
        }
    }

    function renderAttendanceChart(stats) {
        console.log('Rendering class attendance chart with data:', stats);
        
        const ctx = document.getElementById('attendanceChart');
        if (!ctx) {
            console.error('Class attendance chart canvas not found!');
            return;
        }
        
        // Destroy previous chart if it exists
        if (attendanceChart) {
            attendanceChart.destroy();
        }
        
        // Prepare data for chart
        const labels = stats.map(day => {
            const date = new Date(day.date);
            return date.toLocaleDateString();
        });
        
        const presentData = stats.map(day => day.present || 0);
        const absentData = stats.map(day => day.absent || 0);
        const halfDayData = stats.map(day => day.halfDay || 0);
        const leaveData = stats.map(day => day.leave || 0);
        
        // Create the chart
        attendanceChart = new Chart(ctx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Present',
                        data: presentData,
                        backgroundColor: 'rgba(76, 175, 80, 0.7)',
                        borderColor: 'rgba(76, 175, 80, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Absent',
                        data: absentData,
                        backgroundColor: 'rgba(244, 67, 54, 0.7)',
                        borderColor: 'rgba(244, 67, 54, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Half Day',
                        data: halfDayData,
                        backgroundColor: 'rgba(255, 165, 0, 0.7)',
                        borderColor: 'rgba(255, 165, 0, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Leave',
                        data: leaveData,
                        backgroundColor: 'rgba(128, 0, 128, 0.7)',
                        borderColor: 'rgba(128, 0, 128, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Students'
                        },
                        ticks: {
                            stepSize: 1,
                            precision: 0
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Class Attendance Statistics'
                    },
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });
    }

    function populateStudentDropdown() {
        const select = document.getElementById('studentSelect');
        select.innerHTML = '<option value="">-- Select Student --</option>';
        
        studentData.forEach(student => {
            const option = document.createElement('option');
            option.value = student.studentId;
            option.textContent = `${student.studentId} - ${student.studentName}`;
            select.appendChild(option);
        });
    }

async function loadStudentChart() {
    const studentSelect = document.getElementById('studentSelect');
    const studentId = studentSelect.value;
    
    if (!studentId) {
        alert('Please select a student');
        return;
    }
    
    try {
        document.getElementById('loader').style.display = 'flex';
        
        const startDate = document.getElementById('statsStartDate').value;
        const endDate = document.getElementById('statsEndDate').value;
        
        if (!startDate || !endDate) {
            alert('Please select both start and end dates');
            return;
        }
        
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'getStudentAttendance',
                studentId: studentId,
                startDate: startDate,
                endDate: endDate
            })
        });
        
        const data = await response.json();
        console.log('Student attendance data:', data);
        
        if (data.status === 'success') {
            // Update student info display
            const studentInfo = document.getElementById('studentInfo');
            studentInfo.innerHTML = ''; // Clear previous content
            
            // Create container for student info and stats
            const infoContainer = document.createElement('div');
            
            // Basic student info
            const nameElement = document.createElement('div');
            nameElement.textContent = `Student: ${data.studentName} (${data.studentId})`;
            infoContainer.appendChild(nameElement);
            
            // Date range info
            const dateRangeElement = document.createElement('div');
            dateRangeElement.textContent = `Date Range: ${formatDate(startDate)} to ${formatDate(endDate)}`;
            infoContainer.appendChild(dateRangeElement);
            
            // Calculate statistics if records exist
            if (data.records && data.records.length > 0) {
                const stats = calculateStudentStats(data.records);
                
                // Create stats display
                const statsElement = document.createElement('div');
                statsElement.style.marginTop = '10px';
                statsElement.innerHTML = `
                    <strong>Attendance Summary:</strong><br>
                    Present: ${stats.present} (${stats.presentPercentage}%)<br>
                    Absent: ${stats.absent} (${stats.absentPercentage}%)<br>
                    Half Day: ${stats.halfDay} (${stats.halfDayPercentage}%)<br>
                    Leave: ${stats.leave} (${stats.leavePercentage}%)<br>
                    Total Days: ${stats.totalDays}
                `;
                infoContainer.appendChild(statsElement);
                
                renderStudentChart(data.records);
            } else {
                const noDataElement = document.createElement('div');
                noDataElement.style.marginTop = '10px';
                noDataElement.textContent = 'No attendance records found for this student in the selected date range';
                infoContainer.appendChild(noDataElement);
                renderEmptyStudentChart();
            }
            
            studentInfo.appendChild(infoContainer);
            studentInfo.style.display = 'block';
        } else {
            alert(data.message || 'Error loading student attendance');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error loading student attendance');
    } finally {
        document.getElementById('loader').style.display = 'none';
    }
}

function calculateStudentStats(records) {
    const stats = {
        present: 0,
        absent: 0,
        halfDay: 0,
        leave: 0,
        totalDays: records.length
    };
    
    records.forEach(record => {
        const status = record.status.toLowerCase();
        if (status.includes('present')) stats.present++;
        else if (status.includes('absent')) stats.absent++;
        else if (status.includes('half')) stats.halfDay++;
        else if (status.includes('leave')) stats.leave++;
    });
    
    // Calculate percentages
    stats.presentPercentage = Math.round((stats.present / stats.totalDays) * 100);
    stats.absentPercentage = Math.round((stats.absent / stats.totalDays) * 100);
    stats.halfDayPercentage = Math.round((stats.halfDay / stats.totalDays) * 100);
    stats.leavePercentage = Math.round((stats.leave / stats.totalDays) * 100);
    
    return stats;
}

function formatDate(dateString) {
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    return new Date(dateString).toLocaleDateString(undefined, options);
}

    function renderStudentChart(records) {
        const ctx = document.getElementById('studentAttendanceChart');
        if (!ctx) return;
        
        // Destroy previous chart if it exists
        if (studentChart) {
            studentChart.destroy();
        }
        
        // Prepare data
        const labels = records.map(record => {
            const date = new Date(record.date);
            return date.toLocaleDateString();
        });
        
        const statusValues = records.map(record => {
            switch(record.status.toLowerCase()) {
                case 'present': return 3;
                case 'half day': return 2;
                case 'leave': return 1;
                case 'absent': return 0;
                default: return -1;
            }
        });
        
        // Get selected student info
        const studentSelect = document.getElementById('studentSelect');
        const selectedOption = studentSelect.options[studentSelect.selectedIndex].text;
        
        // Create chart
        studentChart = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: `${selectedOption} Attendance`,
                    data: statusValues,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 3,
                        ticks: {
                            callback: function(value) {
                                switch(value) {
                                    case 0: return 'Absent';
                                    case 1: return 'Leave';
                                    case 2: return 'Half Day';
                                    case 3: return 'Present';
                                    default: return '';
                                }
                            },
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const record = records[context.dataIndex];
                                return `Status: ${record.status} (${record.date})`;
                            }
                        }
                    }
                }
            }
        });
    }

    function renderEmptyStudentChart() {
        const ctx = document.getElementById('studentAttendanceChart');
        if (!ctx) return;
        
        if (studentChart) {
            studentChart.destroy();
        }
        
        studentChart = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'No attendance data',
                    data: [],
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 3,
                        ticks: {
                            callback: function(value) {
                                switch(value) {
                                    case 0: return 'Absent';
                                    case 1: return 'Leave';
                                    case 2: return 'Half Day';
                                    case 3: return 'Present';
                                    default: return '';
                                }
                            },
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }
</script>
</body>
</html>
